##### 图书馆借书还书领域建模

###### 案例简述
现要设计一个系统,支持学校图书馆的图书管理。支持学校学生进图书馆进行借书、还书,以及相关查询的场景,具体业务场景描述如下。

###### 业务场景描述
1. 管理员入库新的图书
- 如果是全新的图书,则需要先登记图书,通过扫码图书条形码识别图书编号。
- 如果是已经存在的图书,则只需要更新图书的库存
2. 学生借书
- 学生持卡进图书馆
- 图书管理员扫码图书卡条形码,识别图书卡号。
- 图书管理员扫码图书条形码,识别图书编号。
- 图书管理员更新每本书的数量(如果同一本书借多本的话)。
- 提交借书信息
3. 学生还书
- 学生持卡进图书馆
- 图书管理员扫码图书卡条形码,识别图书卡号。
- 图书管理员扫码图书条形码,识别图书编号。
- 图书管理员更新每本书的数量(如果同一本书还多本的话)。
- 提交还书信息
- 图书归还的时候如果超期就要交罚款
- 不需要跟踪一件书的新旧折损
4. 查询相关场景
- 查询图书馆某本书当前还有多少库存。
- 查询某个图书卡当前已借的书。
- 查询图书卡的借书记录。
- 查询图书卡的还书记录。
- 查询某本书的被借记录。
- 查询某本书的被还记录

###### 业务讨论
- 全新的书：是指图书馆之前没有这本书。识别方法是扫描图书条形码的时候系统自动查询该图书是否存在。
- 查询某本书得记录：学生是不关心，但是管理员有可能关心，比如遇到纠纷时，要查询某本书到底被哪些人借过了。
- 在图书馆里需要追踪一本图书的状态，是在馆、借出、遗失、不可借等等，此时，我们说图书就是具体那一本，但是，我们也会说，这本书还有得借吗？这时可能可能说的是一本书的所有副本是不是还有剩余，所以它的数量可能是大于等于0的数。
- 图书：案例中的图书都不是指副本，是指一本书，它可能在图书馆有10个副本。
- 馆藏号
- 同样的图书应该是用同一个编码，只是每本图书还有一个批次编码表示唯一，这样统计当前图书量时你才能知道这本书还有多少存货
- 我通常习惯从两头去分析，一方面是业务场景，一方面是对象（物）。定义好这两头，再去理其中的关系和域
- 我觉得借还是两种状态，刚好它牵涉到两个行为，至于库存不是一码事。而后面很多的报表又要重新定义出新实体了
- 一本书：表示一本书，更多的强调一个“商品”，我们可以跟踪书的库存
一件书：表示一本书的某一件，一件书表示可以拿在手上的实实在在的“一本物理书”
- 跟踪一件书的新旧折损，我没有在业务场景中提到，可以理解为需求不需要
- 图书馆不跟踪每一个副本，也就是图书实例，而只跟踪书
- 不过，我觉得可以再增加一个需求，就是图书归还的时候如果超期就要交罚款
- 具体怎么判断超期以及罚款的规则，大家可以定一下
- 更正一下，馆藏号和条码号是一样的，应该加上索书号，isbn 就是书的身份行 是唯一的，而索书号是图书馆给每一本书编的号码 用来查询书所在的馆藏位置  条码号是图书馆给自己馆藏的书加的一个私有的”身份证号”
- 我觉得可以按照这个思路去分析：
    - 第一步，找出有哪些业务实体； 
    - 第二步，理清业务实体之间的关系；
    - 第三步 业务实体有哪些基本属性；
    - 第四步，业务实体有哪些操作（或者可对实体进行的操作）
- 实体有图书（编号，图书状态，书名etc），图书卡(图书卡号，学生编号)，图书库存（编号，库存量），借还流水。
入库是跟库存在一个上下文，借书和还书跟图书，借还流水在一个上下文。
- 不是太明白，为什么有副本的概念，书每一本都是唯一的，那也有唯一的编码，那不能就副本，我是这样理解的，同一本内容的是，可能就是相对有一个库存而已。
- 不用图书副本（或者其他名词）的概念，只用库存的概念来管理应该不行的，我们需要追踪每一本书的状态，是什么时候入馆的，目前的状态，所有借还书的记录等等。

###### 理论讨论
- BC通常和子域对应的，所以可以先划分子域，然后默认每个子域一个BC，每个BC中的领域概念没有歧义有明确含义
- 甚至没有BC这个概念也可以，最重要的是要以业务为重，划分业务边界，这个过程就是在划分子域。业务边界明确了，那每个业务边界内进行领域建模即可
- 很多时候根本子域都不用划分，因为领域问题不复杂，业务范围不大，比如我上面的图书馆案例，此时就可以直接建模了
- 如果要做一个淘宝天猫这样的电商平台，那战略思想能力才是关键了，也就是从高到低的业务梳理划分以及架构设计
- 一个聚合至少有一个聚合根，至多也有一个聚合根来保证一致性
- 聚合保证原子性是原则，事务是手段，不能反过来依据事务来找聚合啊。
- 传统ddd是一个bc的业务用例处于同一个事务中，而这个业务用例本身可能跨聚合。
- 聚合是依据业务不变性划分的
- 如果依据面相过程的旧项目中的事务来找聚合，也不过是另一种方式的面向过程而已。
- 聚合是依据业务不变性划分的，能结合图书馆的例子说明一下吗？我觉得说的对，可是不知道怎么下手。
- 方法：
    - 1、找出你关心的所有领域概念；
    - 2、先假设所有概念都是实体，且都是聚合根；
    - 3、利用排除法，分析哪些概念没有独立的生命周期，则排除；
    - 4、把排除的概念放入其他的聚合根下形成聚合
- 你可能会问如果不会分析生命周期咋办？那就这样思考，是否有场景会直接创建或修改该概念，而不是先导航到其他概念再去修改这个概念，如果有，那就是独立聚合根。
- 有些概念没有出现在需求或用户故事里，而是需要自己去提炼抽象的，其实这个才是难点
- 图书管理员更新每本书的数量(如果同一本书借多本的话)。这个，借书时更新图书数量应该是管理员的职责。
- 学生还书，把图书卡与书给管理员，刷卡，扫条码，确认归还图书+数量，这时候图书还在管理员手里，不需要上架流程，对于还书的人来说还完书就可以走了，然后管理员把书放进篮子里，后面慢慢批量放入书架
- 我有一个疑问。借还记录，它能不能算一个聚合根。
- 我在思考的时候脑子闪着，图书是个聚合根，图书卡也是个聚合根，那介于它俩之间产生的记录。借还记录
- 不能，借书和还书都会产生借还记录，业务的不变性条件

###### 业务概念

- 一本书：表示一本书，更多的强调一个“商品”，我们可以跟踪书的库存
- 一件书：表示一本书的某一件，一件书表示可以拿在手上的实实在在的“一本物理书”

###### 精华

- 聚合是依据业务不变性划分的。
- 找聚合的方法：
    - 1、找出你关心的所有领域概念；
    - 2、先假设所有概念都是实体，且都是聚合根；
    - 3、利用排除法，分析哪些概念没有独立的生命周期，则排除；
    - 4、把排除的概念放入其他的聚合根下形成聚合
- 分析生命周期方法：
    - 是否有场景会直接创建或修改该概念，而不是先导航到其他概念再去修改这个概念，如果有，那就是独立聚合根。